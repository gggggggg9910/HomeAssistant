# ASR性能优化方案

## 当前性能分析

根据性能监控日志，当前系统各阶段耗时如下：

- **总耗时**: ~24秒
- **语音识别(ASR)**: ~11.75秒 (48.6%) ⚠️ **最大瓶颈**
  - 音频收集: ~10.16秒 (固定等待)
  - ASR模型推理: ~1.59秒
- **TTS合成与播放**: ~11.66秒 (48.2%)
- **LLM处理**: ~0.78秒 (3.2%)

## 当前使用的ASR模型

- **模型**: `iic/SenseVoiceSmall` (阿里云 SenseVoice 小模型)
- **位置**: `~/models/iic/SenseVoiceSmall`
- **配置**: CPU推理，采样率16kHz

## 已实施的优化

### 1. VAD (语音活动检测) ✅

**问题**: 之前固定等待10秒，即使用户已经说完话也要等满10秒。

**解决方案**: 实现了VAD来动态检测语音结束：
- 检测到连续静音1.5秒后自动结束录音
- 最小录音时长0.8秒（避免误触发）
- 最小语音时长0.5秒（确保有足够语音内容）
- 最大录音时长从10秒降到7秒

**预期效果**: 音频收集时间从~10秒降低到2-4秒（取决于用户说话时长）

### 2. 性能监控 ✅

添加了详细的性能日志，可以清楚看到每个阶段的耗时，便于进一步优化。

## 进一步优化建议

### 1. 模型优化

#### 选项A: 使用更小的模型
- 考虑使用 `iic/SenseVoiceTiny`（如果可用）
- 或者使用其他更轻量的ASR模型（如Whisper Tiny）

#### 选项B: 模型量化
- 使用INT8量化版本的模型
- 可以显著减少推理时间和内存占用

#### 选项C: 使用GPU加速
```python
# 在 config/settings.py 中设置
asr.use_gpu = True  # 如果树莓派有GPU支持
```

### 2. 音频处理优化

#### 选项A: 实时流式识别
- 实现流式ASR，边录音边识别
- 可以提前返回结果，不需要等待完整录音

#### 选项B: 音频压缩
- 在发送到模型前进行适当的音频预处理
- 减少需要处理的数据量

### 3. 配置参数调优

#### 当前配置建议
```python
# config/settings.py
ASRSettings(
    max_wait_seconds: int = 7  # 已优化：从10降到7
    # 可以进一步降到5秒，配合VAD使用
)
```

#### VAD参数调优
在 `core/controller.py` 的 `_recognize_speech` 方法中：
```python
silence_threshold = 0.02      # 可以调整：0.015-0.03
min_speech_duration = 0.5      # 可以调整：0.3-0.8
max_silence_duration = 1.5     # 可以调整：1.0-2.0
min_recording_duration = 0.8   # 可以调整：0.5-1.0
```

### 4. 系统级优化

#### 选项A: 使用更快的存储
- 确保模型文件在SSD上，而不是SD卡
- 使用tmpfs存储临时文件

#### 选项B: CPU优化
- 确保使用多线程推理（如果模型支持）
- 设置合适的CPU亲和性

#### 选项C: 内存优化
- 确保有足够的可用内存
- 避免内存交换（swap）

## 预期优化效果

实施VAD后，预期性能改进：

- **音频收集**: 从~10秒 → ~2-4秒 (节省6-8秒)
- **总ASR时间**: 从~11.75秒 → ~4-6秒 (节省5-7秒)
- **整体响应时间**: 从~24秒 → ~17-19秒 (提升20-30%)

## 监控和调试

使用性能监控日志来跟踪优化效果：

```bash
# 查看性能日志
grep "性能监控总结" logs/assistant.log
grep "VAD" logs/assistant.log
grep "语音识别" logs/assistant.log
```

## 下一步行动

1. ✅ 实施VAD（已完成）
2. ⏳ 测试VAD效果，根据实际使用情况调整参数
3. ⏳ 如果VAD效果不理想，考虑切换到更小的模型
4. ⏳ 如果树莓派有GPU，尝试启用GPU加速
5. ⏳ 考虑实现流式ASR（长期优化）

## 注意事项

- VAD参数需要根据实际环境（噪音水平、麦克风灵敏度）进行调整
- 不同用户的说话习惯不同，可能需要个性化调整
- 在安静环境下，VAD效果最好；在嘈杂环境下可能需要调整阈值
